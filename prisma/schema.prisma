// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  customer
  staff
  admin
}

enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
}

enum RepairJobStatus {
  created
  in_progress
  completed
  delivered
}

enum PaymentMethod {
  CASH
  TRANSFER
  QR_TRANSFER
}

enum PaymentStatus {
  pending
  success
  failed
}

enum QuotationStatus {
  pending_customer_approval
  approved
  rejected
}

enum PointEventType {
  earn
  redeem
  adjust
}

model User {
  id         String   @id @default(uuid()) @db.Uuid
  email      String   @unique
  role       UserRole @default(customer)
  created_at DateTime @default(now()) @db.Timestamptz

  customer Customer?

  @@map("users")
}

model Customer {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @unique @db.Uuid
  full_name  String
  phone      String
  created_at DateTime @default(now()) @db.Timestamptz

  user           User           @relation(fields: [user_id], references: [id])
  motorcycles    Motorcycle[]
  bookings       Booking[]
  loyalty_points LoyaltyPoints?

  @@map("customers")
}

model Motorcycle {
  id            String   @id @default(uuid()) @db.Uuid
  customer_id   String   @db.Uuid
  brand         String
  model         String
  license_plate String   @unique
  year          Int?
  created_at    DateTime @default(now()) @db.Timestamptz

  customer Customer  @relation(fields: [customer_id], references: [id])
  bookings Booking[]

  @@map("motorcycles")
}

model Booking {
  id            String        @id @default(uuid()) @db.Uuid
  customer_id   String        @db.Uuid
  motorcycle_id String        @db.Uuid
  booking_time  DateTime      @db.Timestamptz
  symptom_note  String?
  status        BookingStatus @default(pending)
  created_at    DateTime      @default(now()) @db.Timestamptz

  customer   Customer   @relation(fields: [customer_id], references: [id])
  motorcycle Motorcycle @relation(fields: [motorcycle_id], references: [id])
  estimate   Estimate?
  quotation  Quotation?
  repair_job RepairJob?

  @@map("bookings")
}

model Estimate {
  id             String   @id @default(uuid()) @db.Uuid
  booking_id     String   @unique @db.Uuid
  description    String
  estimated_cost Decimal  @db.Decimal(10, 2)
  created_at     DateTime @default(now()) @db.Timestamptz

  booking Booking @relation(fields: [booking_id], references: [id])

  @@map("estimates")
}

model Quotation {
  id           String          @id @default(uuid()) @db.Uuid
  booking_id   String          @unique @db.Uuid
  total_amount Decimal         @db.Decimal(10, 2)
  status       QuotationStatus @default(pending_customer_approval)
  created_at   DateTime        @default(now()) @db.Timestamptz

  booking    Booking         @relation(fields: [booking_id], references: [id])
  items      QuotationItem[]
  repair_job RepairJob?

  @@map("quotations")
}

model QuotationItem {
  id           String  @id @default(uuid()) @db.Uuid
  quotation_id String  @db.Uuid
  description  String
  labor        Decimal @db.Decimal(10, 2)
  part_id      String? @db.Uuid
  part_qty     Int?

  quotation Quotation @relation(fields: [quotation_id], references: [id])
  part      Part?     @relation(fields: [part_id], references: [id])

  @@map("quotation_items")
}

model RepairJob {
  id                String          @id @default(uuid()) @db.Uuid
  booking_id        String          @unique @db.Uuid
  quotation_id      String?         @unique @db.Uuid
  assigned_staff_id String?         @db.Uuid
  start_date        DateTime?       @db.Timestamptz
  end_date          DateTime?       @db.Timestamptz
  labor_cost        Decimal         @default(0) @db.Decimal(10, 2)
  status            RepairJobStatus @default(created)
  created_at        DateTime        @default(now()) @db.Timestamptz

  booking      Booking      @relation(fields: [booking_id], references: [id])
  quotation    Quotation?   @relation(fields: [quotation_id], references: [id])
  repair_parts RepairPart[]
  payments     Payment[]

  @@map("repair_jobs")
}

model Part {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  stock_qty   Int      @default(0)
  created_at  DateTime @default(now()) @db.Timestamptz

  repair_parts    RepairPart[]
  quotation_items QuotationItem[]

  @@map("parts")
}

model RepairPart {
  id            String @id @default(uuid()) @db.Uuid
  repair_job_id String @db.Uuid
  part_id       String @db.Uuid
  quantity      Int

  repair_job RepairJob @relation(fields: [repair_job_id], references: [id])
  part       Part      @relation(fields: [part_id], references: [id])

  @@map("repair_parts")
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  repair_job_id String        @db.Uuid
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(pending)
  paid_at       DateTime?     @db.Timestamptz
  created_at    DateTime      @default(now()) @db.Timestamptz

  repair_job         RepairJob          @relation(fields: [repair_job_id], references: [id])
  point_transactions PointTransaction[]

  @@map("payments")
}

model LoyaltyPoints {
  id           String   @id @default(uuid()) @db.Uuid
  customer_id  String   @unique @db.Uuid
  total_points Int      @default(0)
  updated_at   DateTime @updatedAt @db.Timestamptz

  customer           Customer           @relation(fields: [customer_id], references: [id])
  point_transactions PointTransaction[]

  @@map("loyalty_points")
}

model PointTransaction {
  id                String         @id @default(uuid()) @db.Uuid
  loyalty_points_id String         @db.Uuid
  payment_id        String?        @db.Uuid
  event_type        PointEventType
  points            Int
  created_at        DateTime       @default(now()) @db.Timestamptz

  loyalty_points LoyaltyPoints @relation(fields: [loyalty_points_id], references: [id])
  payment        Payment?      @relation(fields: [payment_id], references: [id])

  @@map("point_transactions")
}
